# Build Plan Generation Workflow
#
# Triggered when a PR is merged to develop with changes to tech specs.
# Creates a GitHub issue and assigns it to Copilot with the Team Lead agent
# to convert tech specs into build plans.
#
# Required Secrets:
#   COPILOT_PAT - Personal Access Token with the following permissions:
#     - repo (full control of private repositories)
#     - issues:write (to create and update issues)
#   This token is required because the default GITHUB_TOKEN cannot assign
#   issues to the Copilot agent due to GitHub's licensing restrictions.

name: 03 â€” Tech Spec Ready

on:
  push:
    branches:
      - develop
    paths:
      - 'rnd/tech_specs/**'

permissions:
  contents: read
  issues: write

jobs:
  detect-changes:
    name: Detect Tech Spec Changes
    runs-on: ubuntu-latest
    outputs:
      tech_specs_changed: ${{ steps.filter.outputs.tech_specs }}
      changed_files: ${{ steps.filter.outputs.tech_specs_files }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Filter changed files
        uses: dorny/paths-filter@v3
        id: filter
        with:
          list-files: json
          filters: |
            tech_specs:
              - added|modified: 'rnd/tech_specs/**'

  create-build-plan-task:
    name: Create Build Plan Task
    needs: detect-changes
    if: needs.detect-changes.outputs.tech_specs_changed == 'true'
    runs-on: ubuntu-latest
    outputs:
      issue_number: ${{ steps.create-issue.outputs.issue_number }}
    steps:
      - name: Create issue for build plan generation
        id: create-issue
        uses: actions/github-script@v7
        with:
          script: |
            const changedFiles = JSON.parse('${{ needs.detect-changes.outputs.changed_files }}');
            
            // Build the issue body with file locations
            const fileList = changedFiles.map(file => '- `' + file + '`').join('\n');
            const firstFile = changedFiles[0] || 'rnd/tech_specs/';
            const specName = firstFile.split('/').pop().replace('.md', '');
            
            const issueTitle = 'Build Plan: ' + specName;
            const issueBody = [
              '## Task for: Team Lead Agent',
              '',
              '> **Agent Profile:** `.github/agents/team-lead.agent.md`',
              '',
              'A technical specification has been added or updated. Please create the corresponding build plan.',
              '',
              '### Tech Spec File(s)',
              fileList,
              '',
              '### Instructions',
              '1. Read and follow the team lead agent profile at `.github/agents/team-lead.agent.md`',
              '2. Read the technical specification(s) listed above',
              '3. Use the template at `.github/templates/build_plan.md` as the base for the build plan',
              '4. Output the build plan to `rnd/build_plans/` following the naming convention',
              '',
              '### Context',
              'This task was automatically created by the Build Plan workflow when changes were detected in the tech specs directory.',
              '',
              '**Note:** This issue should be assigned to the `team-lead` custom agent. If using the GitHub web interface, please select the `team-lead` agent from the agent dropdown when assigning to Copilot.'
            ].join('\n');

            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: issueTitle,
              body: issueBody,
              labels: ['build-plan', 'copilot']
            });
            
            console.log('Created issue #' + issue.data.number + ': ' + issue.data.title);
            core.setOutput('issue_number', issue.data.number);
            return issue.data.number;

  assign-to-copilot:
    name: Assign to Copilot
    needs: create-build-plan-task
    runs-on: ubuntu-latest
    steps:
      # Note: Currently, the GitHub API does not support assigning a specific
      # custom agent (like 'team-lead') programmatically. The issue is assigned
      # to the default Copilot agent, but includes explicit instructions to
      # follow the team lead agent profile. When GitHub adds API support for
      # custom agent assignment, this step should be updated.
      - name: Assign issue to Copilot
        uses: otto-de/assign_issue_toCopilot_action@v1.0.1
        with:
          issue_number: ${{ needs.create-build-plan-task.outputs.issue_number }}
          github_token: ${{ secrets.COPILOT_PAT }}
